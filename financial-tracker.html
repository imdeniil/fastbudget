<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ç—Ä–µ–∫–µ—Ä –∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6992c5;
            --accent-color: #8bb1e0;
            --light-color: #e5eef9;
            --dark-color: #2c3e50;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f9f9f9;
            color: var(--dark-color);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        .left-column, .right-column {
            display: flex;
            flex-direction: column;
        }
        
        .section-divider {
            border-top: 2px solid var(--light-color);
            margin: 20px 0;
            padding-top: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        h1 {
            text-align: left;
            grid-column: 1 / -1;
            font-size: 2rem;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-color);
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }
        
        button {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }
        
        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .income-section {
            grid-column: 1 / 2;
        }
        
        .expenses-section {
            grid-column: 2 / 3;
        }
        
        .hours-section, .results-section {
            grid-column: 1 / -1;
        }
        
        .category-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .category-item input {
            flex: 1;
            margin-bottom: 0;
            margin-right: 10px;
            border-radius: 6px;
        }
        
        .remove-btn {
            background-color: var(--danger-color);
            width: 40px;
            margin-bottom: 0;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .remove-btn:hover {
            background-color: #c0392b;
        }

        .add-category-btn {
            background-color: var(--success-color);
            font-weight: bold;
            margin-top: 5px;
        }
        
        .add-category-btn:hover {
            background-color: #27ae60;
        }
        
        .primary-action-btn {
            background-color: var(--secondary-color);
            font-weight: bold;
            font-size: 18px;
            padding: 15px;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .primary-action-btn:hover {
            background-color: var(--accent-color);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        
        .primary-action-btn:active {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .input-group {
            margin-bottom: 20px;
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        
        .input-group:hover {
            background-color: #d8e6f6;
        }
        
        .input-group label {
            font-weight: 500;
            color: var(--dark-color);
            margin-bottom: 8px;
        }
        
        .input-group input {
            margin-bottom: 0;
        }
        
        .calculate-button-container {
            margin-top: 30px;
            text-align: center;
        }
        
        .calculate-button-container .primary-action-btn {
            max-width: 300px;
            margin: 0 auto;
            font-size: 18px;
            padding: 15px 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        
        .calculate-button-container .primary-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        
        .full-width {
            width: 100%;
            margin-top: 20px;
        }
        
        .import-export-container {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        
        .action-buttons-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        .main-button-container {
            flex-grow: 1;
            margin-right: 15px;
        }
        
        .main-button-container .primary-action-btn {
            width: 100%;
        }
        
        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            padding: 0;
            background-color: var(--dark-color);
            transition: all 0.2s;
        }
        
        .icon-btn:hover {
            background-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .category-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 10px;
        }
        
        .category-input {
            flex: 1;
            margin-bottom: 0;
        }
        
        .add-btn, .remove-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-size: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.2s;
            vertical-align: middle;
            margin-bottom: 0;
        }
        
        .add-btn {
            background-color: var(--success-color);
        }
        
        .add-btn:hover {
            transform: scale(1.1);
            background-color: #27ae60;
        }
        
        .remove-btn {
            background-color: var(--danger-color);
        }
        
        .remove-btn:hover {
            transform: scale(1.1);
            background-color: #c0392b;
        }
        
        .chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            width: 100%;
        }
        
        #expense-chart {
            width: 100%;
            max-width: 100%;
            height: auto;
            aspect-ratio: 1 / 1;
            margin-bottom: 20px;
        }
        
        .chart-legend {
            width: 100%;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .color-box {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
        }
        
        .result-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .positive {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .negative {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .budget-status {
            font-size: 1.1rem;
            font-weight: bold;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .budget-status.positive {
            background-color: rgba(46, 204, 113, 0.2);
        }
        
        .budget-status.negative {
            background-color: rgba(231, 76, 60, 0.2);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--light-color);
        }
        
        .footer {
            text-align: center;
            margin-top: 20px;
            color: #777;
            font-size: 0.9rem;
            grid-column: 1 / -1;
        }
        
        .import-export {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 15px;
        }
        
        .import-export button {
            flex: 1;
            background-color: var(--dark-color);
        }
        
        .import-export button:hover {
            background-color: #3d5266;
        }
        
        #file-input {
            display: none;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã */
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            max-width: 200px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .chart-container {
            position: relative;
        }
        
        .legend-item {
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .legend-item:hover {
            background-color: var(--light-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ç—Ä–µ–∫–µ—Ä –∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h1>
        
        <div class="left-column">
            <div class="card">
                <h2>üßÆ –î–æ—Ö–æ–¥—ã –∏ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è</h2>
                
                <div class="input-group">
                    <label for="total-income">üí∞ –û–±—â–∏–π –º–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥:</label>
                    <input type="number" id="total-income" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–æ—Ö–æ–¥–∞" min="0">
                </div>
                
                <div class="input-group">
                    <label for="work-hours">‚è∞ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤ –≤ –Ω–µ–¥–µ–ª—é:</label>
                    <input type="number" id="work-hours" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤" value="40" min="1" max="168">
                </div>
                
                <div class="action-buttons-container">
                    <div class="main-button-container">
                        <button id="calculate-btn" class="primary-action-btn">üßÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
                    </div>
                    <div class="import-export-container">
                        <button id="export-btn" class="icon-btn">üì§</button>
                        <button id="import-btn" class="icon-btn">üì•</button>
                        <input type="file" id="file-input" accept=".json">
                    </div>
                </div>
                
                <div class="section-divider"></div>
                
                <h2>üí∏ –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2>
                
                <div class="category-input-container">
                    <input type="text" id="new-category-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" class="category-input">
                    <input type="number" id="new-category-amount" placeholder="–°—É–º–º–∞" min="0" class="category-input">
                    <button id="add-category" class="add-btn">‚ûï</button>
                </div>
                
                <div id="expense-categories">
                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å –ø–æ–º–æ—â—å—é JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="right-column">
            <div class="card">
                <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞</h2>
                <div id="budget-status" class="budget-status">
                    –ë—é–¥–∂–µ—Ç —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω
                </div>
                <table>
                    <tr>
                        <td>üí∞ –û–±—â–∏–π –º–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥:</td>
                        <td id="result-income" class="result-value">0 ‚ÇΩ</td>
                    </tr>
                    <tr>
                        <td>üí∏ –û–±—â–∏–µ –º–µ—Å—è—á–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã:</td>
                        <td id="result-expenses" class="result-value">0 ‚ÇΩ</td>
                    </tr>
                    <tr>
                        <td>‚öñÔ∏è –ë–∞–ª–∞–Ω—Å:</td>
                        <td id="result-balance" class="result-value">0 ‚ÇΩ</td>
                    </tr>
                    <tr>
                        <td>‚è∞ –ê–∫—Ç—É–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ –≤ —á–∞—Å:</td>
                        <td id="result-hourly-rate" class="result-value">0 ‚ÇΩ</td>
                    </tr>
                </table>
            </div>
            
            <div class="card">
                <h2>üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</h2>
                <div class="chart-container">
                    <canvas id="expense-chart"></canvas>
                    <div class="chart-legend" id="chart-legend">
                        <!-- –õ–µ–≥–µ–Ω–¥–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Å –ø–æ–º–æ—â—å—é JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>üîí –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ</p>
        </div>
    </div>

    <script>
        // –¶–≤–µ—Ç–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤
        const COLORS = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', 
            '#FF9F40', '#8AC249', '#EA5545', '#F46A9B', '#EF9B20', 
            '#EDBF33', '#87BC45', '#27AEEF', '#B33DC6'
        ];

        // –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const DEFAULT_CATEGORIES = [
            { name: '–ñ–∏–ª—å–µ', amount: 0 },
            { name: '–ü–∏—Ç–∞–Ω–∏–µ', amount: 0 },
            { name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', amount: 0 },
            { name: '–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏', amount: 0 },
            { name: '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', amount: 0 }
        ];

        // –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let state = {
            income: 0,
            categories: [...DEFAULT_CATEGORIES],
            workHours: 40
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
        function loadState() {
            const savedState = localStorage.getItem('financialTrackerState');
            if (savedState) {
                state = JSON.parse(savedState);
                document.getElementById('total-income').value = state.income;
                document.getElementById('work-hours').value = state.workHours;
                renderCategories();
                calculateResults();
            } else {
                renderCategories();
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
        function saveState() {
            localStorage.setItem('financialTrackerState', JSON.stringify(state));
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤
        function renderCategories() {
            const categoriesContainer = document.getElementById('expense-categories');
            categoriesContainer.innerHTML = '';

            state.categories.forEach((category, index) => {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'category-item';
                
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.placeholder = '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                nameInput.value = category.name;
                nameInput.addEventListener('change', (e) => {
                    state.categories[index].name = e.target.value;
                    saveState();
                    renderChart();
                });
                
                const amountInput = document.createElement('input');
                amountInput.type = 'number';
                amountInput.placeholder = '–°—É–º–º–∞';
                amountInput.value = category.amount;
                amountInput.min = 0;
                amountInput.addEventListener('input', (e) => {
                    state.categories[index].amount = parseFloat(e.target.value) || 0;
                    saveState();
                    calculateResults();
                });
                
                const removeButton = document.createElement('button');
                removeButton.className = 'remove-btn';
                removeButton.innerHTML = '‚úñ';
                removeButton.addEventListener('click', () => {
                    state.categories.splice(index, 1);
                    saveState();
                    renderCategories();
                    calculateResults();
                });
                
                categoryElement.appendChild(nameInput);
                categoryElement.appendChild(amountInput);
                categoryElement.appendChild(removeButton);
                
                categoriesContainer.appendChild(categoryElement);
            });
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
        function addCategory() {
            const nameInput = document.getElementById('new-category-name');
            const amountInput = document.getElementById('new-category-amount');
            
            const categoryName = nameInput.value.trim() || '–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è';
            const categoryAmount = parseFloat(amountInput.value) || 0;
            
            state.categories.push({ name: categoryName, amount: categoryAmount });
            renderCategories();
            saveState();
            
            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            nameInput.value = '';
            amountInput.value = '';
            nameInput.focus();
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –¥–∏–∞–≥—Ä–∞–º–º—ã
            renderChart();
            
            console.log('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞, —Ç–µ–∫—É—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', state.categories);
        }

        // –†–∞—Å—á–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function calculateResults() {
            // –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ —Ñ–æ—Ä–º—ã
            state.income = parseFloat(document.getElementById('total-income').value) || 0;
            state.workHours = parseFloat(document.getElementById('work-hours').value) || 40;
            
            // –†–∞—Å—á–µ—Ç –æ–±—â–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
            const totalExpenses = state.categories.reduce((sum, category) => sum + (parseFloat(category.amount) || 0), 0);
            
            // –†–∞—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞
            const balance = state.income - totalExpenses;
            
            // –†–∞—Å—á–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–æ—á–∞—Å–æ–≤–æ–≥–æ –¥–æ—Ö–æ–¥–∞
            const monthlyWorkHours = state.workHours * 4.33; // –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–¥–µ–ª—å –≤ –º–µ—Å—è—Ü–µ
            const actualHourlyRate = state.income / monthlyWorkHours;
            
            // –†–∞—Å—á–µ—Ç —Ä–∞–∑–Ω–∏—Ü—ã –≤ –ø–æ—á–∞—Å–æ–≤–æ–º –¥–æ—Ö–æ–¥–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–µ—Ñ–∏—Ü–∏—Ç –∏–ª–∏ –ø—Ä–æ—Ñ–∏—Ü–∏—Ç)
            const hourlyRateDifference = balance / monthlyWorkHours;
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            document.getElementById('result-income').textContent = `${state.income.toLocaleString()} ‚ÇΩ`;
            document.getElementById('result-expenses').textContent = `${totalExpenses.toLocaleString()} ‚ÇΩ`;
            
            const balanceElement = document.getElementById('result-balance');
            balanceElement.textContent = `${Math.abs(balance).toLocaleString()} ‚ÇΩ`;
            
            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –±–∞–ª–∞–Ω—Å–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –±—é–¥–∂–µ—Ç–∞
            const budgetStatusElement = document.getElementById('budget-status');
            
            if (balance > 0) {
                balanceElement.className = 'result-value positive';
                budgetStatusElement.textContent = `–ü–†–û–§–ò–¶–ò–¢: —É –≤–∞—Å –æ—Å—Ç–∞–µ—Ç—Å—è ${balance.toLocaleString()} ‚ÇΩ –≤ –º–µ—Å—è—Ü`;
                budgetStatusElement.className = 'budget-status positive';
            } else if (balance < 0) {
                balanceElement.className = 'result-value negative';
                budgetStatusElement.textContent = `–î–ï–§–ò–¶–ò–¢: –≤–∞–º –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ${Math.abs(balance).toLocaleString()} ‚ÇΩ –≤ –º–µ—Å—è—Ü`;
                budgetStatusElement.className = 'budget-status negative';
            } else {
                balanceElement.className = 'result-value';
                budgetStatusElement.textContent = '–ë—é–¥–∂–µ—Ç —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω';
                budgetStatusElement.className = 'budget-status';
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—á–∞—Å–æ–≤–æ–≥–æ –¥–æ—Ö–æ–¥–∞ —Å —Ä–∞–∑–Ω–∏—Ü–µ–π –≤ —Å–∫–æ–±–∫–∞—Ö, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ—Ñ–∏—Ü–∏—Ç –∏–ª–∏ –¥–µ—Ñ–∏—Ü–∏—Ç
            const hourlyRateElement = document.getElementById('result-hourly-rate');
            
            if (balance !== 0) {
                let diffText = '';
                let diffClass = '';
                
                if (balance > 0) {
                    diffText = ` (+${hourlyRateDifference.toLocaleString(undefined, { maximumFractionDigits: 2 })} ‚ÇΩ)`;
                    diffClass = 'positive';
                } else {
                    diffText = ` (‚àí${Math.abs(hourlyRateDifference).toLocaleString(undefined, { maximumFractionDigits: 2 })} ‚ÇΩ)`;
                    diffClass = 'negative';
                }
                
                hourlyRateElement.innerHTML = `${actualHourlyRate.toLocaleString(undefined, { maximumFractionDigits: 2 })} ‚ÇΩ <span class="${diffClass}">${diffText}</span>`;
            } else {
                hourlyRateElement.textContent = `${actualHourlyRate.toLocaleString(undefined, { maximumFractionDigits: 2 })} ‚ÇΩ`;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã
            renderChart();
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            saveState();
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã
        let chartSectors = []; // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ–∫—Ç–æ—Ä–∞—Ö
        let highlightedSectorIndex = -1; // –ò–Ω–¥–µ–∫—Å –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞
        
        function renderChart() {
            const canvas = document.getElementById('expense-chart');
            const ctx = canvas.getContext('2d');
            const legendContainer = document.getElementById('chart-legend');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientWidth; // –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å—Ç–æ—Ä–æ–Ω 1:1
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç—É–ª—Ç–∏–ø. –ï—Å–ª–∏ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
            let tooltip = document.querySelector('.tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                container.appendChild(tooltip);
            }
            
            // –û—á–∏—Å—Ç–∫–∞ —Ö–æ–ª—Å—Ç–∞
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            legendContainer.innerHTML = '';
            
            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å –Ω–µ–Ω—É–ª–µ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
            let validCategories = state.categories.filter(cat => cat.amount > 0);
            
            if (validCategories.length === 0) {
                ctx.font = `${Math.max(16, canvas.width / 20)}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ —É–±—ã–≤–∞–Ω–∏—é —Ä–∞—Å—Ö–æ–¥–æ–≤
            validCategories = validCategories.sort((a, b) => b.amount - a.amount);
            
            // –†–∞—Å—á–µ—Ç –æ–±—â–µ–π —Å—É–º–º—ã —Ä–∞—Å—Ö–æ–¥–æ–≤
            const total = validCategories.reduce((sum, cat) => sum + cat.amount, 0);
            
            // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–∏–∞–≥—Ä–∞–º–º—ã
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) * 0.7; // –£–º–µ–Ω—å—à–∏–ª —Ä–∞–∑–º–µ—Ä –¥–ª—è –º–µ—Ç–æ–∫
            
            // –ù–∞—á–∞–ª—å–Ω—ã–π —É–≥–æ–ª (—Å–≤–µ—Ä—Ö—É = -90 –≥—Ä–∞–¥—É—Å–æ–≤ = -PI/2)
            let startAngle = -Math.PI / 2;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–∞—Å—Å–∏–≤ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–µ–∫—Ç–æ—Ä–∞—Ö
            chartSectors = [];
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ–∫—Ç–æ—Ä–æ–≤
            validCategories.forEach((category, index) => {
                const colorIndex = index % COLORS.length;
                const sliceAngle = (category.amount / total) * 2 * Math.PI;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–∫—Ç–æ—Ä–µ
                chartSectors.push({
                    index,
                    startAngle,
                    endAngle: startAngle + sliceAngle,
                    color: COLORS[colorIndex],
                    category,
                    percent: ((category.amount / total) * 100).toFixed(1)
                });
                
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ–∫—Ç–æ—Ä–∞
                drawSector(ctx, centerX, centerY, radius, startAngle, startAngle + sliceAngle, 
                          COLORS[colorIndex], index === highlightedSectorIndex);
                
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
                const percent = ((category.amount / total) * 100).toFixed(0);
                if (percent >= 5) { // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–µ—Ç–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–µ–∫—Ç–æ—Ä–æ–≤ >= 5%
                    const midAngle = startAngle + sliceAngle / 2;
                    const labelRadius = radius * 0.7; // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –¥–æ –º–µ—Ç–∫–∏
                    const labelX = centerX + Math.cos(midAngle) * labelRadius;
                    const labelY = centerY + Math.sin(midAngle) * labelRadius;
                    
                    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–µ—Ç–∫–∏
                    ctx.font = 'bold 14px Arial';
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${percent}%`, labelX, labelY);
                }
                
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –ª–µ–≥–µ–Ω–¥—ã
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.dataset.index = index;
                
                if (index === highlightedSectorIndex) {
                    legendItem.style.backgroundColor = 'var(--light-color)';
                }
                
                const colorBox = document.createElement('div');
                colorBox.className = 'color-box';
                colorBox.style.backgroundColor = COLORS[colorIndex];
                
                const labelText = document.createElement('span');
                labelText.textContent = `${category.name}: ${category.amount.toLocaleString()} ‚ÇΩ (${((category.amount / total) * 100).toFixed(1)}%)`;
                
                legendItem.appendChild(colorBox);
                legendItem.appendChild(labelText);
                legendContainer.appendChild(legendItem);
                
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫ –ª–µ–≥–µ–Ω–¥–µ
                legendItem.addEventListener('mouseenter', () => {
                    highlightSector(index, tooltip);
                });
                
                legendItem.addEventListener('mouseleave', () => {
                    unhighlightSector(tooltip);
                });
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≥–ª–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞
                startAngle += sliceAngle;
            });
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
            // –°–Ω–∞—á–∞–ª–∞ –∫–ª–æ–Ω–∏—Ä—É–µ–º –Ω–æ–¥—É, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            const oldCanvas = canvas;
            const newCanvas = oldCanvas.cloneNode(true);
            oldCanvas.parentNode.replaceChild(newCanvas, oldCanvas);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã
            newCanvas.addEventListener('mousemove', function(e) {
                handleChartMouseMove(e, this, centerX, centerY, radius, tooltip);
            });
            
            newCanvas.addEventListener('mouseleave', function() {
                unhighlightSector(tooltip);
            });
            
            // –ï—Å–ª–∏ —É –Ω–∞—Å –±—ã–ª –≤—ã–¥–µ–ª–µ–Ω –∫–∞–∫–æ–π-—Ç–æ —Å–µ–∫—Ç–æ—Ä, —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–∞–Ω–≤–∞—Å–∞
            if (highlightedSectorIndex >= 0) {
                const ctx = newCanvas.getContext('2d');
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É —Å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–º —Å–µ–∫—Ç–æ—Ä–æ–º
                highlightSector(highlightedSectorIndex, tooltip);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –æ–¥–Ω–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞
        function drawSector(ctx, centerX, centerY, radius, startAngle, endAngle, color, isHighlighted) {
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, startAngle, endAngle);
            ctx.closePath();
            
            if (isHighlighted || highlightedSectorIndex === -1) {
                ctx.fillStyle = color;
            } else {
                // –ó–∞—Ç–µ–º–Ω—è–µ–º –Ω–µ–≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä—ã
                ctx.fillStyle = adjustBrightness(color, 0.5);
            }
            
            ctx.fill();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏ –ø–æ –¥–∏–∞–≥—Ä–∞–º–º–µ
        function handleChartMouseMove(event, canvas, centerX, centerY, radius, tooltip) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
            const dx = x - centerX;
            const dy = y - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∫—É—Ä—Å–æ—Ä –≤–Ω—É—Ç—Ä–∏ –∫—Ä—É–≥–∞
            if (distance <= radius) {
                // –í—ã—á–∏—Å–ª—è–µ–º —É–≥–æ–ª –≤ —Ä–∞–¥–∏–∞–Ω–∞—Ö (–æ—Ç -œÄ –¥–æ œÄ)
                let angle = Math.atan2(dy, dx);
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —É–≥–æ–ª –≤ –¥–∏–∞–ø–∞–∑–æ–Ω [0, 2œÄ)
                if (angle < 0) angle += 2 * Math.PI;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤ –∫–∞–∫–æ–π —Å–µ–∫—Ç–æ—Ä –¥–∏–∞–≥—Ä–∞–º–º—ã –ø–æ–ø–∞–ª —É–∫–∞–∑–∞—Ç–µ–ª—å –º—ã—à–∏
                let hitIndex = -1;
                
                // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å–µ–∫—Ç–æ—Ä–∞–º –¥–∏–∞–≥—Ä–∞–º–º—ã
                for (let i = 0; i < chartSectors.length; i++) {
                    let startAngle = chartSectors[i].startAngle;
                    let endAngle = chartSectors[i].endAngle;
                    
                    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —É–≥–ª—ã –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É [0, 2œÄ)
                    if (startAngle < 0) startAngle += 2 * Math.PI;
                    if (endAngle < 0) endAngle += 2 * Math.PI;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ —É–≥–æ–ª –≤ —Ç–µ–∫—É—â–∏–π —Å–µ–∫—Ç–æ—Ä
                    if (endAngle < startAngle) { // –°–µ–∫—Ç–æ—Ä –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ 0/2œÄ
                        if (angle >= startAngle || angle <= endAngle) {
                            hitIndex = i;
                            break;
                        }
                    } else { // –û–±—ã—á–Ω—ã–π —Å–ª—É—á–∞–π
                        if (angle >= startAngle && angle <= endAngle) {
                            hitIndex = i;
                            break;
                        }
                    }
                }
                
                if (hitIndex !== -1) {
                    // –ù–∞—à–ª–∏ —Å–µ–∫—Ç–æ—Ä, –≤—ã–¥–µ–ª—è–µ–º –µ–≥–æ
                    if (highlightedSectorIndex !== hitIndex) {
                        highlightSector(hitIndex, tooltip, x, y);
                    } else {
                        // –ï—Å–ª–∏ —É–∂–µ –≤—ã–¥–µ–ª–µ–Ω —ç—Ç–æ—Ç —Å–µ–∫—Ç–æ—Ä, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ç—É–ª—Ç–∏–ø–∞
                        tooltip.style.left = `${x + 15}px`;
                        tooltip.style.top = `${y + 15}px`;
                    }
                    return;
                }
            }
            
            // –ï—Å–ª–∏ –∫—É—Ä—Å–æ—Ä –Ω–µ –Ω–∞–¥ —Å–µ–∫—Ç–æ—Ä–æ–º
            unhighlightSector(tooltip);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞
        function highlightSector(index, tooltip, x, y) {
            // –ï—Å–ª–∏ —É–∂–µ –≤—ã–¥–µ–ª–µ–Ω —ç—Ç–æ—Ç –∂–µ —Å–µ–∫—Ç–æ—Ä, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
            if (highlightedSectorIndex === index) return;
            
            // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Å–µ–∫—Ç–æ—Ä
            highlightedSectorIndex = index;
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞
            const sector = chartSectors[index];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ª–µ–≥–µ–Ω–¥—ã
            document.querySelectorAll('.legend-item').forEach(item => {
                if (parseInt(item.dataset.index) === index) {
                    item.style.backgroundColor = 'var(--light-color)';
                } else {
                    item.style.backgroundColor = '';
                }
            });
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É
            const canvas = document.getElementById('expense-chart');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) * 0.7;
            
            // –û—á–∏—â–∞–µ–º —Ö–æ–ª—Å—Ç
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ç–æ—Ä–∞
            chartSectors.forEach(sector => {
                drawSector(
                    ctx, 
                    centerX, 
                    centerY, 
                    radius, 
                    sector.startAngle, 
                    sector.endAngle, 
                    sector.color, 
                    sector.index === highlightedSectorIndex
                );
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
                const percent = Number(sector.percent).toFixed(0);
                if (percent >= 5) {
                    const midAngle = (sector.startAngle + sector.endAngle) / 2;
                    const labelRadius = radius * 0.7;
                    const labelX = centerX + Math.cos(midAngle) * labelRadius;
                    const labelY = centerY + Math.sin(midAngle) * labelRadius;
                    
                    ctx.font = 'bold 14px Arial';
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${percent}%`, labelX, labelY);
                }
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—É–ª—Ç–∏–ø
            tooltip.style.opacity = '1';
            tooltip.innerHTML = `<strong>${sector.category.name}</strong><br>
                               –°—É–º–º–∞: ${sector.category.amount.toLocaleString()} ‚ÇΩ<br>
                               –î–æ–ª—è: ${sector.percent}%`;
                               
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Ç—É–ª—Ç–∏–ø–∞
            if (x && y) {
                tooltip.style.left = `${x + 15}px`;
                tooltip.style.top = `${y + 15}px`;
            } else {
                // –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã (–Ω–∞–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –ª–µ–≥–µ–Ω–¥—É), —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ–º —Ç—É–ª—Ç–∏–ø –≤ —Ü–µ–Ω—Ç—Ä–µ —Å–µ–∫—Ç–æ—Ä–∞
                const midAngle = (sector.startAngle + sector.endAngle) / 2;
                const tooltipRadius = radius * 0.5;
                const tooltipX = centerX + Math.cos(midAngle) * tooltipRadius;
                const tooltipY = centerY + Math.sin(midAngle) * tooltipRadius;
                
                tooltip.style.left = `${tooltipX}px`;
                tooltip.style.top = `${tooltipY}px`;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–Ω—è—Ç–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å —Å–µ–∫—Ç–æ—Ä–∞
        function unhighlightSector(tooltip) {
            if (highlightedSectorIndex === -1) return;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            highlightedSectorIndex = -1;
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Ç—É–ª—Ç–∏–ø
            tooltip.style.opacity = '0';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤ –ª–µ–≥–µ–Ω–¥–µ
            document.querySelectorAll('.legend-item').forEach(item => {
                item.style.backgroundColor = '';
            });
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É
            const canvas = document.getElementById('expense-chart');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) * 0.7;
            
            // –û—á–∏—â–∞–µ–º —Ö–æ–ª—Å—Ç
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ç–æ—Ä–∞ –±–µ–∑ –≤—ã–¥–µ–ª–µ–Ω–∏—è
            chartSectors.forEach(sector => {
                drawSector(
                    ctx, 
                    centerX, 
                    centerY, 
                    radius, 
                    sector.startAngle, 
                    sector.endAngle, 
                    sector.color, 
                    true
                );
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
                const percent = Number(sector.percent).toFixed(0);
                if (percent >= 5) {
                    const midAngle = (sector.startAngle + sector.endAngle) / 2;
                    const labelRadius = radius * 0.7;
                    const labelX = centerX + Math.cos(midAngle) * labelRadius;
                    const labelY = centerY + Math.sin(midAngle) * labelRadius;
                    
                    ctx.font = 'bold 14px Arial';
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${percent}%`, labelX, labelY);
                }
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–∞
        function adjustBrightness(color, factor) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º HEX –≤ RGB
            let r = parseInt(color.slice(1, 3), 16);
            let g = parseInt(color.slice(3, 5), 16);
            let b = parseInt(color.slice(5, 7), 16);
            
            // –ó–∞—Ç–µ–º–Ω—è–µ–º
            r = Math.floor(r * factor);
            g = Math.floor(g * factor);
            b = Math.floor(b * factor);
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ RGBA
            return `rgba(${r}, ${g}, ${b}, 0.7)`;
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ JSON
        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'financial-tracker-data.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedState = JSON.parse(e.target.result);
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
                    if (importedState && typeof importedState === 'object' && 
                        'income' in importedState && 
                        'categories' in importedState && 
                        Array.isArray(importedState.categories) && 
                        'workHours' in importedState) {
                            
                        state = importedState;
                        document.getElementById('total-income').value = state.income;
                        document.getElementById('work-hours').value = state.workHours;
                        renderCategories();
                        calculateResults();
                        alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
                    } else {
                        alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞');
                }
                
                // –°–±—Ä–æ—Å –∑–Ω–∞—á–µ–Ω–∏—è input —Ñ–∞–π–ª–∞
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            loadState();
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            const addCategoryButton = document.getElementById('add-category');
            if (addCategoryButton) {
                addCategoryButton.addEventListener('click', addCategory);
                console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            } else {
                console.error('–ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
            }
            
            document.getElementById('calculate-btn').addEventListener('click', calculateResults);
            document.getElementById('total-income').addEventListener('input', calculateResults);
            document.getElementById('work-hours').addEventListener('input', calculateResults);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–º–ø–æ—Ä—Ç–∞/—ç–∫—Å–ø–æ—Ä—Ç–∞
            document.getElementById('export-btn').addEventListener('click', exportData);
            document.getElementById('import-btn').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });
            document.getElementById('file-input').addEventListener('change', importData);
            
            // –ù–∞—á–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç
            calculateResults();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    renderChart();
                }, 250); // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ–≥–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–Ω–∏—è
            });
        });
    </script>
</body>
</html>
