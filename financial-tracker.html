<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Финансовый трекер и калькулятор</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6992c5;
            --accent-color: #8bb1e0;
            --light-color: #e5eef9;
            --dark-color: #2c3e50;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f9f9f9;
            color: var(--dark-color);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        .left-column, .right-column {
            display: flex;
            flex-direction: column;
        }
        
        .section-divider {
            border-top: 2px solid var(--light-color);
            margin: 20px 0;
            padding-top: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        h1 {
            text-align: left;
            grid-column: 1 / -1;
            font-size: 2rem;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-color);
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }
        
        button {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }
        
        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .income-section {
            grid-column: 1 / 2;
        }
        
        .expenses-section {
            grid-column: 2 / 3;
        }
        
        .hours-section, .results-section {
            grid-column: 1 / -1;
        }
        
        .category-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .category-item input {
            flex: 1;
            margin-bottom: 0;
            margin-right: 10px;
            border-radius: 6px;
        }
        
        .remove-btn {
            background-color: var(--danger-color);
            width: 40px;
            margin-bottom: 0;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .remove-btn:hover {
            background-color: #c0392b;
        }

        .add-category-btn {
            background-color: var(--success-color);
            font-weight: bold;
            margin-top: 5px;
        }
        
        .add-category-btn:hover {
            background-color: #27ae60;
        }
        
        .primary-action-btn {
            background-color: var(--secondary-color);
            font-weight: bold;
            font-size: 18px;
            padding: 15px;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .primary-action-btn:hover {
            background-color: var(--accent-color);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        
        .primary-action-btn:active {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .input-group {
            margin-bottom: 20px;
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        
        .input-group:hover {
            background-color: #d8e6f6;
        }
        
        .input-group label {
            font-weight: 500;
            color: var(--dark-color);
            margin-bottom: 8px;
        }
        
        .input-group input {
            margin-bottom: 0;
        }
        
        .calculate-button-container {
            margin-top: 30px;
            text-align: center;
        }
        
        .calculate-button-container .primary-action-btn {
            max-width: 300px;
            margin: 0 auto;
            font-size: 18px;
            padding: 15px 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }
        
        .calculate-button-container .primary-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        
        .full-width {
            width: 100%;
            margin-top: 20px;
        }
        
        .import-export-container {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        
        .action-buttons-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        .main-button-container {
            flex-grow: 1;
            margin-right: 15px;
        }
        
        .main-button-container .primary-action-btn {
            width: 100%;
        }
        
        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            padding: 0;
            background-color: var(--dark-color);
            transition: all 0.2s;
        }
        
        .icon-btn:hover {
            background-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .category-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 10px;
        }
        
        .category-input {
            flex: 1;
            margin-bottom: 0;
        }
        
        .add-btn, .remove-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-size: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.2s;
            vertical-align: middle;
            margin-bottom: 0;
        }
        
        .add-btn {
            background-color: var(--success-color);
        }
        
        .add-btn:hover {
            transform: scale(1.1);
            background-color: #27ae60;
        }
        
        .remove-btn {
            background-color: var(--danger-color);
        }
        
        .remove-btn:hover {
            transform: scale(1.1);
            background-color: #c0392b;
        }
        
        .chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            width: 100%;
        }
        
        #expense-chart {
            width: 100%;
            max-width: 100%;
            height: auto;
            aspect-ratio: 1 / 1;
            margin-bottom: 20px;
        }
        
        .chart-legend {
            width: 100%;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .color-box {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
        }
        
        .result-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .positive {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .negative {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .budget-status {
            font-size: 1.1rem;
            font-weight: bold;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .budget-status.positive {
            background-color: rgba(46, 204, 113, 0.2);
        }
        
        .budget-status.negative {
            background-color: rgba(231, 76, 60, 0.2);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--light-color);
        }
        
        .footer {
            text-align: center;
            margin-top: 20px;
            color: #777;
            font-size: 0.9rem;
            grid-column: 1 / -1;
        }
        
        .import-export {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 15px;
        }
        
        .import-export button {
            flex: 1;
            background-color: var(--dark-color);
        }
        
        .import-export button:hover {
            background-color: #3d5266;
        }
        
        #file-input {
            display: none;
        }
        
        /* Стили для интерактивной диаграммы */
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            max-width: 200px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .chart-container {
            position: relative;
        }
        
        .legend-item {
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .legend-item:hover {
            background-color: var(--light-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Финансовый трекер и калькулятор</h1>
        
        <div class="left-column">
            <div class="card">
                <h2>🧮 Доходы и рабочее время</h2>
                
                <div class="input-group">
                    <label for="total-income">💰 Общий месячный доход:</label>
                    <input type="number" id="total-income" placeholder="Введите сумму дохода" min="0">
                </div>
                
                <div class="input-group">
                    <label for="work-hours">⏰ Количество рабочих часов в неделю:</label>
                    <input type="number" id="work-hours" placeholder="Введите количество часов" value="40" min="1" max="168">
                </div>
                
                <div class="action-buttons-container">
                    <div class="main-button-container">
                        <button id="calculate-btn" class="primary-action-btn">🧮 Рассчитать</button>
                    </div>
                    <div class="import-export-container">
                        <button id="export-btn" class="icon-btn">📤</button>
                        <button id="import-btn" class="icon-btn">📥</button>
                        <input type="file" id="file-input" accept=".json">
                    </div>
                </div>
                
                <div class="section-divider"></div>
                
                <h2>💸 Расходы по категориям</h2>
                
                <div class="category-input-container">
                    <input type="text" id="new-category-name" placeholder="Название категории" class="category-input">
                    <input type="number" id="new-category-amount" placeholder="Сумма" min="0" class="category-input">
                    <button id="add-category" class="add-btn">➕</button>
                </div>
                
                <div id="expense-categories">
                    <!-- Категории будут добавлены с помощью JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="right-column">
            <div class="card">
                <h2>📊 Результаты расчета</h2>
                <div id="budget-status" class="budget-status">
                    Бюджет сбалансирован
                </div>
                <table>
                    <tr>
                        <td>💰 Общий месячный доход:</td>
                        <td id="result-income" class="result-value">0 ₽</td>
                    </tr>
                    <tr>
                        <td>💸 Общие месячные расходы:</td>
                        <td id="result-expenses" class="result-value">0 ₽</td>
                    </tr>
                    <tr>
                        <td>⚖️ Баланс:</td>
                        <td id="result-balance" class="result-value">0 ₽</td>
                    </tr>
                    <tr>
                        <td>⏰ Актуальный доход в час:</td>
                        <td id="result-hourly-rate" class="result-value">0 ₽</td>
                    </tr>
                </table>
            </div>
            
            <div class="card">
                <h2>📋 Структура расходов</h2>
                <div class="chart-container">
                    <canvas id="expense-chart"></canvas>
                    <div class="chart-legend" id="chart-legend">
                        <!-- Легенда будет добавлена с помощью JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>🔒 Все данные хранятся локально в вашем браузере</p>
        </div>
    </div>

    <script>
        // Цвета для категорий расходов
        const COLORS = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', 
            '#FF9F40', '#8AC249', '#EA5545', '#F46A9B', '#EF9B20', 
            '#EDBF33', '#87BC45', '#27AEEF', '#B33DC6'
        ];

        // Значения по умолчанию
        const DEFAULT_CATEGORIES = [
            { name: 'Жилье', amount: 0 },
            { name: 'Питание', amount: 0 },
            { name: 'Транспорт', amount: 0 },
            { name: 'Коммунальные услуги', amount: 0 },
            { name: 'Развлечения', amount: 0 }
        ];

        // Хранение состояния приложения
        let state = {
            income: 0,
            categories: [...DEFAULT_CATEGORIES],
            workHours: 40
        };

        // Загрузка данных из localStorage при запуске
        function loadState() {
            const savedState = localStorage.getItem('financialTrackerState');
            if (savedState) {
                state = JSON.parse(savedState);
                document.getElementById('total-income').value = state.income;
                document.getElementById('work-hours').value = state.workHours;
                renderCategories();
                calculateResults();
            } else {
                renderCategories();
            }
        }

        // Сохранение данных в localStorage
        function saveState() {
            localStorage.setItem('financialTrackerState', JSON.stringify(state));
        }

        // Отображение категорий расходов
        function renderCategories() {
            const categoriesContainer = document.getElementById('expense-categories');
            categoriesContainer.innerHTML = '';

            state.categories.forEach((category, index) => {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'category-item';
                
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.placeholder = 'Название категории';
                nameInput.value = category.name;
                nameInput.addEventListener('change', (e) => {
                    state.categories[index].name = e.target.value;
                    saveState();
                    renderChart();
                });
                
                const amountInput = document.createElement('input');
                amountInput.type = 'number';
                amountInput.placeholder = 'Сумма';
                amountInput.value = category.amount;
                amountInput.min = 0;
                amountInput.addEventListener('input', (e) => {
                    state.categories[index].amount = parseFloat(e.target.value) || 0;
                    saveState();
                    calculateResults();
                });
                
                const removeButton = document.createElement('button');
                removeButton.className = 'remove-btn';
                removeButton.innerHTML = '✖';
                removeButton.addEventListener('click', () => {
                    state.categories.splice(index, 1);
                    saveState();
                    renderCategories();
                    calculateResults();
                });
                
                categoryElement.appendChild(nameInput);
                categoryElement.appendChild(amountInput);
                categoryElement.appendChild(removeButton);
                
                categoriesContainer.appendChild(categoryElement);
            });
        }

        // Добавление новой категории расходов
        function addCategory() {
            const nameInput = document.getElementById('new-category-name');
            const amountInput = document.getElementById('new-category-amount');
            
            const categoryName = nameInput.value.trim() || 'Новая категория';
            const categoryAmount = parseFloat(amountInput.value) || 0;
            
            state.categories.push({ name: categoryName, amount: categoryAmount });
            renderCategories();
            saveState();
            
            // Очистка полей ввода
            nameInput.value = '';
            amountInput.value = '';
            nameInput.focus();
            
            // Перерисовка диаграммы
            renderChart();
            
            console.log('Категория добавлена, текущие категории:', state.categories);
        }

        // Расчет результатов
        function calculateResults() {
            // Получение значений из формы
            state.income = parseFloat(document.getElementById('total-income').value) || 0;
            state.workHours = parseFloat(document.getElementById('work-hours').value) || 40;
            
            // Расчет общих расходов
            const totalExpenses = state.categories.reduce((sum, category) => sum + (parseFloat(category.amount) || 0), 0);
            
            // Расчет баланса
            const balance = state.income - totalExpenses;
            
            // Расчет актуального почасового дохода
            const monthlyWorkHours = state.workHours * 4.33; // Примерное количество недель в месяце
            const actualHourlyRate = state.income / monthlyWorkHours;
            
            // Расчет разницы в почасовом доходе (если есть дефицит или профицит)
            const hourlyRateDifference = balance / monthlyWorkHours;
            
            // Отображение результатов
            document.getElementById('result-income').textContent = `${state.income.toLocaleString()} ₽`;
            document.getElementById('result-expenses').textContent = `${totalExpenses.toLocaleString()} ₽`;
            
            const balanceElement = document.getElementById('result-balance');
            balanceElement.textContent = `${Math.abs(balance).toLocaleString()} ₽`;
            
            // Изменение цвета баланса и отображение статуса бюджета
            const budgetStatusElement = document.getElementById('budget-status');
            
            if (balance > 0) {
                balanceElement.className = 'result-value positive';
                budgetStatusElement.textContent = `ПРОФИЦИТ: у вас остается ${balance.toLocaleString()} ₽ в месяц`;
                budgetStatusElement.className = 'budget-status positive';
            } else if (balance < 0) {
                balanceElement.className = 'result-value negative';
                budgetStatusElement.textContent = `ДЕФИЦИТ: вам не хватает ${Math.abs(balance).toLocaleString()} ₽ в месяц`;
                budgetStatusElement.className = 'budget-status negative';
            } else {
                balanceElement.className = 'result-value';
                budgetStatusElement.textContent = 'Бюджет сбалансирован';
                budgetStatusElement.className = 'budget-status';
            }
            
            // Отображение почасового дохода с разницей в скобках, если есть профицит или дефицит
            const hourlyRateElement = document.getElementById('result-hourly-rate');
            
            if (balance !== 0) {
                let diffText = '';
                let diffClass = '';
                
                if (balance > 0) {
                    diffText = ` (+${hourlyRateDifference.toLocaleString(undefined, { maximumFractionDigits: 2 })} ₽)`;
                    diffClass = 'positive';
                } else {
                    diffText = ` (−${Math.abs(hourlyRateDifference).toLocaleString(undefined, { maximumFractionDigits: 2 })} ₽)`;
                    diffClass = 'negative';
                }
                
                hourlyRateElement.innerHTML = `${actualHourlyRate.toLocaleString(undefined, { maximumFractionDigits: 2 })} ₽ <span class="${diffClass}">${diffText}</span>`;
            } else {
                hourlyRateElement.textContent = `${actualHourlyRate.toLocaleString(undefined, { maximumFractionDigits: 2 })} ₽`;
            }
            
            // Обновление диаграммы
            renderChart();
            
            // Сохранение данных
            saveState();
        }

        // Отрисовка круговой диаграммы
        let chartSectors = []; // Глобальный массив для хранения информации о секторах
        let highlightedSectorIndex = -1; // Индекс выделенного сектора
        
        function renderChart() {
            const canvas = document.getElementById('expense-chart');
            const ctx = canvas.getContext('2d');
            const legendContainer = document.getElementById('chart-legend');
            
            // Устанавливаем размеры canvas в соответствии с размерами контейнера
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientWidth; // Для сохранения соотношения сторон 1:1
            
            // Проверяем, есть ли уже тултип. Если нет, создаем его
            let tooltip = document.querySelector('.tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                container.appendChild(tooltip);
            }
            
            // Очистка холста
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            legendContainer.innerHTML = '';
            
            // Фильтрация и сортировка категорий с ненулевыми значениями
            let validCategories = state.categories.filter(cat => cat.amount > 0);
            
            if (validCategories.length === 0) {
                ctx.font = `${Math.max(16, canvas.width / 20)}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText('Нет данных для отображения', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Сортировка категорий по убыванию расходов
            validCategories = validCategories.sort((a, b) => b.amount - a.amount);
            
            // Расчет общей суммы расходов
            const total = validCategories.reduce((sum, cat) => sum + cat.amount, 0);
            
            // Параметры диаграммы
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) * 0.7; // Уменьшил размер для меток
            
            // Начальный угол (сверху = -90 градусов = -PI/2)
            let startAngle = -Math.PI / 2;
            
            // Сбрасываем массив с информацией о секторах
            chartSectors = [];
            
            // Отрисовка секторов
            validCategories.forEach((category, index) => {
                const colorIndex = index % COLORS.length;
                const sliceAngle = (category.amount / total) * 2 * Math.PI;
                
                // Сохраняем информацию о секторе
                chartSectors.push({
                    index,
                    startAngle,
                    endAngle: startAngle + sliceAngle,
                    color: COLORS[colorIndex],
                    category,
                    percent: ((category.amount / total) * 100).toFixed(1)
                });
                
                // Отрисовка сектора
                drawSector(ctx, centerX, centerY, radius, startAngle, startAngle + sliceAngle, 
                          COLORS[colorIndex], index === highlightedSectorIndex);
                
                // Добавление метки на графике
                const percent = ((category.amount / total) * 100).toFixed(0);
                if (percent >= 5) { // Отображаем метки только для секторов >= 5%
                    const midAngle = startAngle + sliceAngle / 2;
                    const labelRadius = radius * 0.7; // Расстояние от центра до метки
                    const labelX = centerX + Math.cos(midAngle) * labelRadius;
                    const labelY = centerY + Math.sin(midAngle) * labelRadius;
                    
                    // Отрисовка метки
                    ctx.font = 'bold 14px Arial';
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${percent}%`, labelX, labelY);
                }
                
                // Добавление элемента легенды
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.dataset.index = index;
                
                if (index === highlightedSectorIndex) {
                    legendItem.style.backgroundColor = 'var(--light-color)';
                }
                
                const colorBox = document.createElement('div');
                colorBox.className = 'color-box';
                colorBox.style.backgroundColor = COLORS[colorIndex];
                
                const labelText = document.createElement('span');
                labelText.textContent = `${category.name}: ${category.amount.toLocaleString()} ₽ (${((category.amount / total) * 100).toFixed(1)}%)`;
                
                legendItem.appendChild(colorBox);
                legendItem.appendChild(labelText);
                legendContainer.appendChild(legendItem);
                
                // Добавление интерактивности к легенде
                legendItem.addEventListener('mouseenter', () => {
                    highlightSector(index, tooltip);
                });
                
                legendItem.addEventListener('mouseleave', () => {
                    unhighlightSector(tooltip);
                });
                
                // Обновление угла для следующего сектора
                startAngle += sliceAngle;
            });
            
            // Удаляем все старые обработчики событий, чтобы избежать дублирования
            // Сначала клонируем ноду, чтобы удалить все обработчики
            const oldCanvas = canvas;
            const newCanvas = oldCanvas.cloneNode(true);
            oldCanvas.parentNode.replaceChild(newCanvas, oldCanvas);
            
            // Добавляем обработчик событий для интерактивности диаграммы
            newCanvas.addEventListener('mousemove', function(e) {
                handleChartMouseMove(e, this, centerX, centerY, radius, tooltip);
            });
            
            newCanvas.addEventListener('mouseleave', function() {
                unhighlightSector(tooltip);
            });
            
            // Если у нас был выделен какой-то сектор, требуется обновить контекст для нового канваса
            if (highlightedSectorIndex >= 0) {
                const ctx = newCanvas.getContext('2d');
                // Перерисовываем диаграмму с выделенным сектором
                highlightSector(highlightedSectorIndex, tooltip);
            }
        }
        
        // Функция для отрисовки одного сектора
        function drawSector(ctx, centerX, centerY, radius, startAngle, endAngle, color, isHighlighted) {
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, startAngle, endAngle);
            ctx.closePath();
            
            if (isHighlighted || highlightedSectorIndex === -1) {
                ctx.fillStyle = color;
            } else {
                // Затемняем невыбранные секторы
                ctx.fillStyle = adjustBrightness(color, 0.5);
            }
            
            ctx.fill();
        }
        
        // Функция для обработки движения мыши по диаграмме
        function handleChartMouseMove(event, canvas, centerX, centerY, radius, tooltip) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // Вычисляем расстояние от центра
            const dx = x - centerX;
            const dy = y - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            // Проверяем, находится ли курсор внутри круга
            if (distance <= radius) {
                // Вычисляем угол в радианах (от -π до π)
                let angle = Math.atan2(dy, dx);
                
                // Преобразуем угол в диапазон [0, 2π)
                if (angle < 0) angle += 2 * Math.PI;
                
                // Проверяем, в какой сектор диаграммы попал указатель мыши
                let hitIndex = -1;
                
                // Проходим по всем секторам диаграммы
                for (let i = 0; i < chartSectors.length; i++) {
                    let startAngle = chartSectors[i].startAngle;
                    let endAngle = chartSectors[i].endAngle;
                    
                    // Нормализуем углы к диапазону [0, 2π)
                    if (startAngle < 0) startAngle += 2 * Math.PI;
                    if (endAngle < 0) endAngle += 2 * Math.PI;
                    
                    // Проверяем, попадает ли угол в текущий сектор
                    if (endAngle < startAngle) { // Сектор проходит через 0/2π
                        if (angle >= startAngle || angle <= endAngle) {
                            hitIndex = i;
                            break;
                        }
                    } else { // Обычный случай
                        if (angle >= startAngle && angle <= endAngle) {
                            hitIndex = i;
                            break;
                        }
                    }
                }
                
                if (hitIndex !== -1) {
                    // Нашли сектор, выделяем его
                    if (highlightedSectorIndex !== hitIndex) {
                        highlightSector(hitIndex, tooltip, x, y);
                    } else {
                        // Если уже выделен этот сектор, просто обновляем позицию тултипа
                        tooltip.style.left = `${x + 15}px`;
                        tooltip.style.top = `${y + 15}px`;
                    }
                    return;
                }
            }
            
            // Если курсор не над сектором
            unhighlightSector(tooltip);
        }
        
        // Функция для выделения сектора
        function highlightSector(index, tooltip, x, y) {
            // Если уже выделен этот же сектор, ничего не делаем
            if (highlightedSectorIndex === index) return;
            
            // Запоминаем выделенный сектор
            highlightedSectorIndex = index;
            
            // Получаем данные сектора
            const sector = chartSectors[index];
            
            // Обновляем все элементы легенды
            document.querySelectorAll('.legend-item').forEach(item => {
                if (parseInt(item.dataset.index) === index) {
                    item.style.backgroundColor = 'var(--light-color)';
                } else {
                    item.style.backgroundColor = '';
                }
            });
            
            // Перерисовываем диаграмму
            const canvas = document.getElementById('expense-chart');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) * 0.7;
            
            // Очищаем холст
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Перерисовываем все сектора
            chartSectors.forEach(sector => {
                drawSector(
                    ctx, 
                    centerX, 
                    centerY, 
                    radius, 
                    sector.startAngle, 
                    sector.endAngle, 
                    sector.color, 
                    sector.index === highlightedSectorIndex
                );
                
                // Добавляем метки на графике
                const percent = Number(sector.percent).toFixed(0);
                if (percent >= 5) {
                    const midAngle = (sector.startAngle + sector.endAngle) / 2;
                    const labelRadius = radius * 0.7;
                    const labelX = centerX + Math.cos(midAngle) * labelRadius;
                    const labelY = centerY + Math.sin(midAngle) * labelRadius;
                    
                    ctx.font = 'bold 14px Arial';
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${percent}%`, labelX, labelY);
                }
            });
            
            // Показываем тултип
            tooltip.style.opacity = '1';
            tooltip.innerHTML = `<strong>${sector.category.name}</strong><br>
                               Сумма: ${sector.category.amount.toLocaleString()} ₽<br>
                               Доля: ${sector.percent}%`;
                               
            // Устанавливаем позицию тултипа
            if (x && y) {
                tooltip.style.left = `${x + 15}px`;
                tooltip.style.top = `${y + 15}px`;
            } else {
                // Если координаты не переданы (наведение на легенду), располагаем тултип в центре сектора
                const midAngle = (sector.startAngle + sector.endAngle) / 2;
                const tooltipRadius = radius * 0.5;
                const tooltipX = centerX + Math.cos(midAngle) * tooltipRadius;
                const tooltipY = centerY + Math.sin(midAngle) * tooltipRadius;
                
                tooltip.style.left = `${tooltipX}px`;
                tooltip.style.top = `${tooltipY}px`;
            }
        }
        
        // Функция для снятия выделения с сектора
        function unhighlightSector(tooltip) {
            if (highlightedSectorIndex === -1) return;
            
            // Сбрасываем выделение
            highlightedSectorIndex = -1;
            
            // Скрываем тултип
            tooltip.style.opacity = '0';
            
            // Сбрасываем выделение в легенде
            document.querySelectorAll('.legend-item').forEach(item => {
                item.style.backgroundColor = '';
            });
            
            // Перерисовываем диаграмму
            const canvas = document.getElementById('expense-chart');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) * 0.7;
            
            // Очищаем холст
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Перерисовываем все сектора без выделения
            chartSectors.forEach(sector => {
                drawSector(
                    ctx, 
                    centerX, 
                    centerY, 
                    radius, 
                    sector.startAngle, 
                    sector.endAngle, 
                    sector.color, 
                    true
                );
                
                // Добавляем метки на графике
                const percent = Number(sector.percent).toFixed(0);
                if (percent >= 5) {
                    const midAngle = (sector.startAngle + sector.endAngle) / 2;
                    const labelRadius = radius * 0.7;
                    const labelX = centerX + Math.cos(midAngle) * labelRadius;
                    const labelY = centerY + Math.sin(midAngle) * labelRadius;
                    
                    ctx.font = 'bold 14px Arial';
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${percent}%`, labelX, labelY);
                }
            });
        }
        
        // Функция для затемнения цвета
        function adjustBrightness(color, factor) {
            // Преобразуем HEX в RGB
            let r = parseInt(color.slice(1, 3), 16);
            let g = parseInt(color.slice(3, 5), 16);
            let b = parseInt(color.slice(5, 7), 16);
            
            // Затемняем
            r = Math.floor(r * factor);
            g = Math.floor(g * factor);
            b = Math.floor(b * factor);
            
            // Преобразуем обратно в RGBA
            return `rgba(${r}, ${g}, ${b}, 0.7)`;
        }

        // Экспорт данных в JSON
        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'financial-tracker-data.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // Импорт данных из JSON
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedState = JSON.parse(e.target.result);
                    
                    // Проверка корректности данных
                    if (importedState && typeof importedState === 'object' && 
                        'income' in importedState && 
                        'categories' in importedState && 
                        Array.isArray(importedState.categories) && 
                        'workHours' in importedState) {
                            
                        state = importedState;
                        document.getElementById('total-income').value = state.income;
                        document.getElementById('work-hours').value = state.workHours;
                        renderCategories();
                        calculateResults();
                        alert('Данные успешно импортированы');
                    } else {
                        alert('Некорректный формат файла');
                    }
                } catch (error) {
                    console.error('Ошибка при чтении файла:', error);
                    alert('Ошибка при чтении файла');
                }
                
                // Сброс значения input файла
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Загрузка состояния
            loadState();
            
            // Добавление обработчиков событий
            const addCategoryButton = document.getElementById('add-category');
            if (addCategoryButton) {
                addCategoryButton.addEventListener('click', addCategory);
                console.log('Обработчик для кнопки добавления категории установлен');
            } else {
                console.error('Кнопка добавления категории не найдена!');
            }
            
            document.getElementById('calculate-btn').addEventListener('click', calculateResults);
            document.getElementById('total-income').addEventListener('input', calculateResults);
            document.getElementById('work-hours').addEventListener('input', calculateResults);
            
            // Обработчики импорта/экспорта
            document.getElementById('export-btn').addEventListener('click', exportData);
            document.getElementById('import-btn').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });
            document.getElementById('file-input').addEventListener('change', importData);
            
            // Начальный расчет
            calculateResults();
            
            // Добавляем обработчик для адаптивности диаграммы
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    renderChart();
                }, 250); // Задержка для предотвращения слишком частого перерисовывания
            });
        });
    </script>
</body>
</html>
